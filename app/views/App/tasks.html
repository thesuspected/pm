<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>pm - tasks</title>
    <link rel="icon" href="/public/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/public/css/style.css" type="text/css">
    <link rel="stylesheet" href="/public/codebase/webix.css" type="text/css">
    <link rel="stylesheet" href="/public/kanban/codebase/kanban.css" type="text/css">
    <link rel="stylesheet" href="/public/MaterialDesign/css/materialdesignicons.css" type="text/css"
          charset="utf-8">
    <script src="/public/codebase/webix.js" type="text/javascript"></script>
    <script src="/public/kanban/codebase/kanban.js" type="text/javascript"></script>
    <script src="/public/codebase/i18n/ru.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<script type="module">

    import {locale} from '/public/js/locale.js';						    // локализация канбана

    webix.i18n.locales["ru-RU"].kanban = locale;
    webix.i18n.setLocale('ru-RU');

    import {ProjectModel} from "/public/js/project/model/ProjectModel.js";  // db requests  -  проекты
    import {GroupModel} from "/public/js/group/model/GroupModel.js";        // db requests  -  группы
    import {EmployeeModel} from "/public/js/employee/model/EmployeeModel.js";// db requests -  сотрудники
    import {RefModel} from "/public/js/ref/model/RefModel.js";              // db requests  -  селекты
    import {TaskModel} from "/public/js/task/model/TaskModel.js";           // db requests  -  задачи

    ///////////////////////////////////////////////// Виджеты //////////////////////////////////////////////////////

    import {toolbar} from "/public/js/toolbar.js";							// шапка
    import {sidebar} from "/public/js/sidebar.js";							// боковая панель

    import {projects} from "/public/js/project/projects.js";				// островок Проекты
    import {kanban} from "/public/js/task/kanban.js";						// островок Задачи

    import {projectWindow} from "/public/js/project/projectWindow.js";		// окно проекта
    webix.ui(projectWindow);

    import {editPopup} from "/public/js/editPopup.js";		                // попап списка [редактировать / удалить]
    webix.ui(editPopup);

    import {sortPopup} from "/public/js/sortPopup.js";						// попап сортировки [по порядку / по имени / по дате]
    webix.ui(sortPopup);

    import {basket} from "/public/js/basket.js";                            // корзина для DnD

    import {projects_originalValues} from "/public/js/origValuesForm.js";   // оригинальные значения формы проекта
    import {tasks_originalValues} from "/public/js/origValuesForm.js";      // оригинальные значения формы задачи

    ////////////////////////////////////////////////// Функции /////////////////////////////////////////////////////

    function sortProject(value) {
        $$("listProject").sort("#" + value + "#");
    };

    //************************************************** Проекты ***************************************************//

    function addProjectForm() {
        // получаем актуальные группы
        getGroupSelect();
        // Изменяем форму
        $$("titleP").setValue("Добавить проект");
        $$("dltProjectFormBtn").disable();
        $$("saveProjectFormBtn").hide();
        $$("createProjectFormBtn").show();
        // заносим стандартные значения в форму
        $$("project_Form").setValues(projects_originalValues);
        $$("project_window").show();
    }

    function editProjectForm() {
        // получаем актуальные группы
        getGroupSelect();
        // Изменяем форму
        $$("titleP").setValue("Изменить проект");
        $$("createProjectFormBtn").hide();
        $$("dltProjectFormBtn").enable();
        $$("saveProjectFormBtn").show();
        $$("edit_Popup").hide();
        // заносим данные проекта в форму
        let id = $$("listProject").getSelectedId();
        fillProjectForm(id);
        // открываем окно проекта
        $$("project_window").show();
    }

    function getAllProjects() {
        // запрос на получение всех проектов
        ProjectModel.getAll().then(function (result) {
            $$("listProject").parse(result, 'json');
        });
    }

    function createProject() {
        // Валидация заполнения
        if ($$("project_Form").validate()) {
            // берем значения формы
            let project_form = $$("project_Form").getValues();
            let project = {
                Name: project_form.name,
                Group: project_form.group
            };
            // делаем запрос в бд
            ProjectModel.create(project).then(function (result) {
                getLastProject(result[0].id);
            });
            // закрываем окно
            $$("project_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проекту"});
    }

    function delProject() {
        // закрываем окна
        $$("edit_Popup").hide();
        $$("project_window").hide();
        // подтверждение удаления
        webix.confirm({
            ok: "ОК", cancel: "Отмена",
            text: "Вы собираетесь удалить проект, вы уверены?"
        })
            .then(function () {
                // Берем id проекта
                let id = $$("listProject").getSelectedId();
                // делаем запрос в бд
                ProjectModel.delete(id).then(function(result) {
                    $$("listProject").remove(result);
                });
            })
    }

    function updateProject() {
        // Валидация заполнения
        if ($$("project_Form").validate()) {
            // берем значения формы
            let id = $$("listProject").getSelectedId();
            let project_form = $$("project_Form").getValues();
            let project = {
                Id: id,
                Name: project_form.name,
                Group: project_form.group
            };
            // делаем запрос в бд
            ProjectModel.update(project).then(function(result) {
                refreshProject(result[0].id);
            });
            // закрываем окно
            $$("project_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проекту"});
    }

    function getLastProject(id) {
        // делаем запрос в бд
        ProjectModel.get(id).then(function (result) {
            // Добавляем проект в конец списка
            $$("listProject").add({
                id: result[0]['id'],
                name: result[0]['name'],
                date: new Date(result[0]['date']),
                group: result[0]['group']
            });
        });
    }

    function refreshProject(id) {
        // делаем запрос в бд
        ProjectModel.get(id).then(function (result) {
            // обновляем данные о проекте
            let item = $$("listProject").getItem(result[0]['id']);
            item.name = result[0]['name'];
            item.group = result[0]['group'];
            $$("listProject").refresh();
        });
    }

    function fillProjectForm(id) {
        // делаем запрос в бд
        ProjectModel.getFk(id).then(function (result) {
            // Создаем массив для формы
            let values = {};
            values["name"] = result[0]["name"];
            values["group"] = result[0]["group"];
            // Заполняем форму проекта
            $$("project_Form").setValues(values);
        });
    }

    //************************************************** Задачи ***************************************************//

    function getAllTasks() {
        let project_id = $$('listProject').getSelectedId();
        $$('kanban').clearAll();
        // запрос на получение всех задач
        TaskModel.getAll(project_id).then(function (result) {
            if (result != null) {
                // получаем id выбранного проекта
                let project = $$('listProject').getSelectedId();
                // проходимся по каждой задаче
                for (let i = 0; i < result.length; i++) {
                    // меняем формат даты
                    result[i].date = new Date(result[i].date);
                    // добавляем теги
                    TaskModel.getTags(result[i].id, project).then(function (tags) {
                        let str = [];
                        if (tags != null) {
                            for (let j = 0; j < tags.length; j++) {
                                str[j] = parseInt(tags[j].value);
                            }
                        }
                        result[i].tags = str;
                    });
                }
            }
            // вынужденная задержка для прогрузки тэгов
            setTimeout(function () {$$("kanban").parse(result)}, 170);
        });
    }

    function createTask() {
        let task = $$('kanban_form').getValues();               // получаем значения формы
        task.project = "" + $$('listProject').getSelectedId();  // заносим выбранный проект
        // делаем запрос создания задачи
        TaskModel.create(task).then(function (result) {
            // делаем запрос на получение задачи
            TaskModel.getFk(result[0].id, task.project).then(function (item) {
                // добавляем задачу
                $$('kanban').add(item[0]);
            });
        });
    }

    function delTask(id) {
        // берем текущий проект
        let project = $$('listProject').getSelectedId();
        // делаем запрос
        TaskModel.delete(id, project).then(function (result_id) {
            // задача на удаление
            let task = $$('kanban').getItem(result_id);
            webix.message({type:"debug", text:"Задача <i>" + task.text + "</i> удалёна"});
            $$('kanban').remove(result_id);
        });
    }

    function updateTask(task) {
        let project = $$('listProject').getSelectedId();
        // обновляем задачу
        TaskModel.update(task).then(function (result) {
            // добавить обновление с сервера?
        });
        // обновляем теги задачи
        TaskModel.getTags(task.id, task.project).then(function (tags) {
            // переносим теги ДО в массив
            let before = [];
            if (tags) {
                for (let i = 0; i < tags.length; i++) {
                    before[i] = tags[i].value;
                }
            }
            // переносим теги ПОСЛЕ в массив
            let after = task.tags;

            // выбираем длину
            let len;
            if (after.length > before.length) len = after.length;
            else len = before.length;

            // заполняем массив для отправки
            let tag = {};
            tag.id = task.id;

            // проходимся по массивам
            for (let j = 0; j < len; j++) {

                // если элемент сущ.
                if (before[j]) {
                    // ищем старый тег в новом массиве
                    let elem = after.indexOf(before[j]);
                    // если его нет - удаляем
                    if (elem === -1) {
                        tag.value = before[j];              // дополняем массив для отправки
                        TaskModel.deleteTag(tag, project);  // делаем запрос на удаление
                    }
                }

                // если элемент сущ.
                if (after[j]) {
                    // ищем новый тег в старом массиве
                    let elem = before.indexOf(after[j]);
                    // если его нет - добавляем
                    if (elem === -1) {
                        tag.value = after[j];               // дополняем массив для отправки
                        TaskModel.createTag(tag, project);  // делаем запрос на создание
                    }
                }
            }
        })
    }

    //************************************************** Подзадачи ***************************************************//

    function fillSubTasksForm(id) {
        // делаем запрос
        TaskModel.getAllSub(id).then(function (result) {
            // добавляем подзадачи
            $$('subTasksTable').parse(result);
        });
    }

    function createSubTask() {
        // заполняем подзадачу
        let sub = {};
        sub.id = "";
        sub.value = $$('textSubTask').getValue();
        sub.task = $$('kanban').getSelectedId();
        sub.check = false;
        // делаем запрос
        TaskModel.createSub(sub).then(function (result) {
            // добавляем подзадачу
            $$('subTasksTable').add(result[0]);
        });
        // очищаем поле ввода
        $$('textSubTask').setValue("");
    }

    function deleteSubTask(sub) {
        // удаляем подзадачу из бд
        TaskModel.deleteSub(sub);
        // удаляем подзадачу из таблицы
        $$('subTasksTable').remove(sub.id);
    }
    
    function updateSubTask(sub) {
        // При нажатии check в шапке, больше 5 записей не обрабатывается
        // обновляем задачу в бд
        TaskModel.updateSub(sub);
    }

    //************************************************** Select ***************************************************//

    function getGroupSelect() {
        // делаем запрос в бд
        GroupModel.getAll().then(function (result) {
            // создаем массив для Select
            let selectGroup = [];
            // заполняем группы
            for (let i = 0; i < result.length; i++) {
                selectGroup[i] = {};
                selectGroup[i].id = result[i].id;
                selectGroup[i].value = result[i].name;
            }
            // заносим в select
            $$("groupSelect").define("options", selectGroup);
            $$("groupSelect").refresh();
        });
    }

    function getAssignSelect() {
        let project = $$('listProject').getSelectedId();
        // делаем запрос выбранного проекта
        ProjectModel.getFk(project).then(function (result) {
            // узнаем нужную группу сотрудников
            let group = result[0].group;
            // делаем запрос сотрудников
            EmployeeModel.getByGroupFk(group).then(function (result) {
                // создаем массив для Select
                let selectAssign = [];
                // заполняем сотрудников
                for (let i = 0; i < result.length; i++) {
                    selectAssign[i] = {};
                    selectAssign[i].id = result[i].id;
                    selectAssign[i].value = result[i].lastName;
                }
                // заносим в select
                $$("assignSelect").define("options", selectAssign);
                $$("assignSelect").refresh();
            });
        });
    }

    function getPrioritySelect() {
        // делаем запрос в бд
        RefModel.getPriority().then(function (result) {
            // заносим в select
            $$("prioritySelect").define("data", result);
            $$("prioritySelect").refresh();
        });
    }

    function getStatusSelect() {
        // делаем запрос в бд
        RefModel.getStatus().then(function (result) {
            // заносим в select
            $$("statusSelect").define("options", result);
            $$("statusSelect").refresh();
        });
    }

    function getTagsSelect() {
        // делаем запрос в бд
        RefModel.getTags().then(function (result) {
            // заносим в select
            $$("tagsSelect").define("options", result);
            $$("tagsSelect").refresh();
        });
    }

    ///////////////////////////////////////////////// Отрисовка ////////////////////////////////////////////////////

    window.onload = function () {
        webix.ready(function () {

            // Скролл
            if (!webix.env.touch && webix.env.scrollSize)
                webix.CustomScroll.init();

            // Разметка
            webix.ui({
                rows: [
                    toolbar,
                    {
                        cols: [
                            sidebar,
                            {
                                type: "space",
                                cols: [
                                    {
                                        gravity: 0.3,
                                        type: "wide",
                                        rows: [
                                            projects
                                        ]
                                    },
                                    {
                                        rows: [
                                            kanban,
                                            basket
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            });

            // Получаем все проекты
            getAllProjects();

            // заполняем селекты
            getGroupSelect();
            getTagsSelect();
            getPrioritySelect();
            getStatusSelect();

            // Подсветка текущей вкладки
            $$("sidebar").select("tasks", true);

            // скрываем корзину
            $$('basket').hide();

            //////////////////////////////////////////// Обработчики ///////////////////////////////////////////////

            // Действия после загрузки проектов
            $$('listProject').attachEvent("onAfterLoad", function(){
                // селектим первый проект
                this.select(this.getFirstId());
            });

            // Переход по вкладкам
            $$("sidebar").attachEvent("onItemClick", function (id) {
                location.href = id;
            });

            // Открыть/закрыть sidebar
            $$("toggleIcon").attachEvent("onItemClick", function () {
                $$("sidebar").toggle()
            });

            //********************************************** Проекты ***********************************************//

            // Добавить проект
            $$("addProjectBtn").attachEvent("onItemClick", function () {
                addProjectForm()
            });

            // Окно заполнения проекта
            $$("dltProjectFormBtn").attachEvent("onItemClick", function () {    // кнопка удалить
                delProject();
                $$('project_Form').clearValidation();
            });
            $$("createProjectFormBtn").attachEvent("onItemClick", function () { // кнопка создать
                createProject();
            });
            $$("saveProjectFormBtn").attachEvent("onItemClick", function () {   // кнопка сохранить
                updateProject();
            });
            $$("closeProjectFormBtn").attachEvent("onItemClick", function () {  // кнопка закрыть
                $$('project_window').hide();
                $$('project_Form').clearValidation();
            });

            // Показать попап проекта
            $$("listProject").on_click.listIcon = function (node) {
                $$("edit_Popup").show(node);
            };

            // Действия попапа проекта
            $$("editPopup_List").attachEvent("onItemClick", function (id) {
                let value = this.getItem(id).value;
                switch (value) {
                    case "edit":
                        editProjectForm();
                        break;
                    case "delete":
                        delProject();
                        break;
                }
            });

            // Действия попапа сортировки
            $$("sortPopup_List").attachEvent("onSelectChange", function () {
                let value = this.getSelectedItem().value;
                sortProject(value);
            });

            // Click по проекту (Сделать смену задач)
            $$("listProject").attachEvent("onSelectChange", function () {
                getAllTasks();
                getAssignSelect();
            });

            // Редактирование проекта по doubleClick
            $$("listProject").attachEvent("onItemDblClick", function () {
                editProjectForm();
            });

            //********************************************** Задачи ***********************************************//

            // Добавить задачу
            $$("addTaskBtn").attachEvent("onItemClick", function () {
                $$("kanban").showEditor();
                $$('subTasksTable').clearAll(); // очищаем таблицу подзадач
                $$('enterSubTask').hide();      // скрываем ввод подзадачи
                $$('kanban_form').setValues(tasks_originalValues);
            });

            // Создание задачи
            $$('kanban').data.attachEvent("onBeforeAdd", function (id, item) {
                // игнорируем создание задачи канбаном
                if (Number.isInteger(item.id)) {
                    createTask();
                    return false;
                }
                // разрешаем создание из функции
                else return true;
            });

            // Изменение задачи
            $$('kanban').data.attachEvent("onDataUpdate", function(id, index){
                let task = $$('kanban').getItem(id);
                updateTask(task);
            });

            // Валидация заполнения задачи
            $$("kanban").attachEvent("onBeforeEditorAction", function (action, editor, obj) {
                if (action === "save" && !editor.getForm().validate())
                    return false;
                // Перемещение DnD
                else if (action === "save") {
                    obj.$list = parseInt(obj.status);
                }
                // Удаление задачи
                else if (action === "delete") {
                    let id = $$('kanban').getSelectedId();
                    delTask(id);
                }
            });

            // Очищение валидации при закрытии окна
            $$("kanban").getEditor().attachEvent("onHide", function () {
                this.getForm().clearValidation();
            });

            //********************************************** Подзадачи ***********************************************//

            // Заполнение подзадач перед открытием
            $$("kanban").attachEvent("onBeforeEditorShow", function (editor, obj) {
                $$('subTasksTable').clearAll(); // очищаем таблицу подзадач
                $$('enterSubTask').hide();      // скрываем ввод подзадачи
                // если задача создана
                if (obj) {
                    fillSubTasksForm(obj.id)
                }
            });

            // Показать поле ввода подзадачи
            $$("subTasksTable").on_click.addSubtaskBtn = function (node) {
                $$('enterSubTask').show();
            };

            // Скрыть поле ввода подзадачи
            $$("closeEnterSubTaskBtn").attachEvent("onItemClick", function () {
                $$('enterSubTask').hide();
                $$('textSubTask').setValue("");
            });

            // Добавить подзадачу
            $$("saveSubTaskBtn").attachEvent("onItemClick", function () {
                createSubTask();
            });
            // press Enter
            $$("textSubTask").attachEvent("onEnter",function(ev){
                createSubTask();
            });

            // Удалить подзадачу
            $$("subTasksTable").on_click.delSubtaskBtn = function (node) {
                let sub = $$('subTasksTable').getSelectedItem();
                deleteSubTask(sub);
            };

            // Изменение подзадачи
            $$('subTasksTable').attachEvent("onAfterEditStop", function(state, editor, ignoreUpdate){
                if(state.value !== state.old){
                    let sub = $$('subTasksTable').getSelectedItem();
                    updateSubTask(sub);
                }
            });

            // Изменение check
            $$('subTasksTable').attachEvent("onCheck", function(row, column, state){
                $$('subTasksTable').select(row);
                let sub = $$('subTasksTable').getSelectedItem();
                updateSubTask(sub);
            });

            //********************************************* Drag & Drop **********************************************//

            // получаем node корзины
            let basket_id = $$("basket").getNode();

            webix.attachEvent("onDragMode",function(signal){
                // событие при сбросе элемента над областью корзины
                basket_id.addEventListener('mouseup', handler);
                // показать/скрыть корзину
                switch (signal) {
                    case 'start':
                        $$('basket').show();
                        break;
                    case 'stop':
                        $$('basket').hide();
                        break;
                }
            });

            function handler() {
                // получаем контекст взятия элемента
                let dnd = webix.DragControl.getContext();
                let item = $$('kanban').getItem(dnd.start);
                // определяем откуда пришел дроп
                switch (dnd.from.name) {
                    case 'kanbanlist':
                        delTask(dnd.start);
                        break;
                    case 'Вписать лист проектов':
                        deleteFromGroup(dnd.start);
                        break;
                }
            }
        });
    }
</script>
</body>
</html>