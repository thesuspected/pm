<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>pm - tasks</title>
    <link rel="stylesheet" href="/public/css/style.css" type="text/css">
    <link rel="stylesheet" href="/public/codebase/webix.css" type="text/css">
    <link rel="stylesheet" href="/public/kanban/codebase/kanban.css" type="text/css">
    <link rel="stylesheet" href="/public/MaterialDesign/css/materialdesignicons.css" type="text/css"
          charset="utf-8">
    <script src="/public/codebase/webix.js" type="text/javascript"></script>
    <script src="/public/kanban/codebase/kanban.js" type="text/javascript"></script>
    <script src="/public/codebase/i18n/ru.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<script type="module">

    import {locale} from '/public/js/locale.js';						    // локализация канбана

    webix.i18n.locales["ru-RU"].kanban = locale;
    webix.i18n.setLocale('ru-RU');

    import {ProjectModel} from "/public/js/project/model/ProjectModel.js";  // db requests  -  проекты
    import {GroupModel} from "/public/js/group/model/GroupModel.js";        // db requests  -  группы
    import {EmployeeModel} from "/public/js/employee/model/EmployeeModel.js";// db requests -  сотрудники
    import {RefModel} from "/public/js/ref/model/RefModel.js";              // db requests  -  селекты
    import {TaskModel} from "/public/js/task/model/TaskModel.js";           // db requests  -  задачи

    ///////////////////////////////////////////////// Виджеты //////////////////////////////////////////////////////

    import {toolbar} from "/public/js/toolbar.js";							// шапка
    import {sidebar} from "/public/js/sidebar.js";							// боковая панель

    import {projects} from "/public/js/project/projects.js";				// островок Проекты
    import {kanban} from "/public/js/task/kanban.js";						// островок Задачи

    import {projectWindow} from "/public/js/project/projectWindow.js";		// окно проекта
    webix.ui(projectWindow);

    import {editPopup} from "/public/js/editPopup.js";		                // попап списка [редактировать / удалить]
    webix.ui(editPopup);

    import {sortPopup} from "/public/js/sortPopup.js";						// попап сортировки [по порядку / по имени / по дате]
    webix.ui(sortPopup);

    import {basket} from "/public/js/basket.js";                            // корзина для DnD

    import {projects_originalValues} from "/public/js/origValuesForm.js";   // оригинальные значения формы проекта
    import {tasks_originalValues} from "/public/js/origValuesForm.js";         // оригинальные значения формы задачи

    ////////////////////////////////////////////////// Функции /////////////////////////////////////////////////////

    function sortProject(value) {
        $$("listProject").sort("#" + value + "#");
    };

    //************************************************** Проекты ***************************************************//

    function addProjectForm() {
        // получаем актуальные группы
        getGroupSelect();
        // Изменяем форму
        $$("titleP").setValue("Добавить проект");
        $$("dltProjectFormBtn").disable();
        $$("saveProjectFormBtn").hide();
        $$("createProjectFormBtn").show();
        // заносим стандартные значения в форму
        $$("project_Form").setValues(projects_originalValues);
        $$("project_window").show();
    }

    function editProjectForm() {
        // получаем актуальные группы
        getGroupSelect();
        // Изменяем форму
        $$("titleP").setValue("Изменить проект");
        $$("createProjectFormBtn").hide();
        $$("dltProjectFormBtn").enable();
        $$("saveProjectFormBtn").show();
        $$("edit_Popup").hide();
        // заносим данные проекта в форму
        let id = $$("listProject").getSelectedId();
        fillProjectForm(id);
        // открываем окно проекта
        $$("project_window").show();
    }

    function getAllProjects() {
        // запрос на получение всех проектов
        ProjectModel.getAll().then(function (result) {
            $$("listProject").parse(result, 'json');
        });
    }

    function createProject() {
        // Валидация заполнения
        if ($$("project_Form").validate()) {
            // берем значения формы
            let project_form = $$("project_Form").getValues();
            let project = {
                Name: project_form.name,
                Group: project_form.group
            };
            // делаем запрос в бд
            ProjectModel.create(project).then(function (result) {
                getLastProject(result[0].id);
            });
            // закрываем окно
            $$("project_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проекту"});
    }

    function delProject() {
        // закрываем окна
        $$("edit_Popup").hide();
        $$("project_window").hide();
        // подтверждение удаления
        webix.confirm({
            ok: "ОК", cancel: "Отмена",
            text: "Вы собираетесь удалить проект, вы уверены?"
        })
            .then(function () {
                // Берем id проекта
                let id = $$("listProject").getSelectedId();
                // делаем запрос в бд
                ProjectModel.delete(id).then(function(result) {
                    $$("listProject").remove(result);
                });
            })
    }

    function updateProject() {
        // Валидация заполнения
        if ($$("project_Form").validate()) {
            // берем значения формы
            let id = $$("listProject").getSelectedId();
            let project_form = $$("project_Form").getValues();
            let project = {
                Id: id,
                Name: project_form.name,
                Group: project_form.group
            };
            // делаем запрос в бд
            ProjectModel.update(project).then(function(result) {
                refreshProject(result[0].id);
            });
            // закрываем окно
            $$("project_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проекту"});
    }

    function getLastProject(id) {
        // делаем запрос в бд
        ProjectModel.get(id).then(function (result) {
            // Добавляем проект в конец списка
            $$("listProject").add({
                id: result[0]['id'],
                name: result[0]['name'],
                date: new Date(result[0]['date']),
                group: result[0]['group']
            });
        });
    }

    function refreshProject(id) {
        // делаем запрос в бд
        ProjectModel.get(id).then(function (result) {
            // обновляем данные о проекте
            let item = $$("listProject").getItem(result[0]['id']);
            item.name = result[0]['name'];
            item.group = result[0]['group'];
            $$("listProject").refresh();
        });
    }

    function fillProjectForm(id) {
        // делаем запрос в бд
        ProjectModel.getFk(id).then(function (result) {
            // Создаем массив для формы
            let values = {};
            values["name"] = result[0]["name"];
            values["group"] = result[0]["group"];
            // Заполняем форму проекта
            $$("project_Form").setValues(values);
        });
    }

    //************************************************** Задачи ***************************************************//

    function getAllTasks() {
        let project_id = $$('listProject').getSelectedId();
        $$('kanban').clearAll();
        // запрос на получение всех задач
        TaskModel.getAll(project_id).then(function (result) {
            if (result != null) {
                // получаем id выбранного проекта
                let project = $$('listProject').getSelectedId();
                // проходимся по каждой задаче
                for (let i = 0; i < result.length; i++) {
                    // меняем формат даты
                    result[i].date = new Date(result[i].date);
                    // добавляем теги
                    TaskModel.getTags(result[i].id, project).then(function (tags) {
                        let str = [];
                        for (let j = 0; j < tags.length; j++) {
                            str[j] = parseInt(tags[j].value);
                        }
                        result[i].tags = str;
                    });
                }
            }
            console.log(result);
            $$("kanban").parse(result, 'json');
        });
    }

    function createTask() {
        let task = $$('kanban_form').getValues();
        task.project = "" + $$('listProject').getSelectedId();
        console.log(task);
        TaskModel.create(task).then(function (result) {

        });
    }

    function delTask(id) {
        let project = $$('listProject').getSelectedId();
        console.log(id);
        console.log(project);
        TaskModel.delete(id, project).then(function (result) {
            console.log('успех');
        });
    }

    function updateTask(task) {
        TaskModel.update(task).then(function (result) {
            console.log('успех');
        });
    }

    //************************************************** Select ***************************************************//

    function getGroupSelect() {
        // делаем запрос в бд
        GroupModel.getAll().then(function (result) {
            // создаем массив для Select
            let selectGroup = [];
            // заполняем группы
            for (let i = 0; i < result.length; i++) {
                selectGroup[i] = {};
                selectGroup[i].id = result[i].id;
                selectGroup[i].value = result[i].name;
            }
            // заносим в select
            $$("groupSelect").define("options", selectGroup);
            $$("groupSelect").refresh();
        });
    }

    function getAssignSelect() {
        let project = $$('listProject').getSelectedId();
        // делаем запрос выбранного проекта
        ProjectModel.getFk(project).then(function (result) {
            // узнаем нужную группу сотрудников
            let group = result[0].group;
            // делаем запрос сотрудников
            EmployeeModel.getByGroupFk(group).then(function (result) {
                // создаем массив для Select
                let selectAssign = [];
                // заполняем сотрудников
                for (let i = 0; i < result.length; i++) {
                    selectAssign[i] = {};
                    selectAssign[i].id = result[i].id;
                    selectAssign[i].value = result[i].lastName;
                }
                // заносим в select
                $$("assignSelect").define("options", selectAssign);
                $$("assignSelect").refresh();
            });
        });
    }

    function getPrioritySelect() {
        // делаем запрос в бд
        RefModel.getPriority().then(function (result) {
            // заносим в select
            $$("prioritySelect").define("data", result);
            $$("prioritySelect").refresh();
            // неудачная попытка ранней загрузки
            // $$("kanban").define("colors", result);
            // console.log($$("kanban").config.colors);
            // console.log("^^-----colors-----^^");
            // $$("kanban").reconstruct();
        });
    }

    function getStatusSelect() {
        // делаем запрос в бд
        RefModel.getStatus().then(function (result) {
            // заносим в select
            console.log(result);
            $$("statusSelect").define("options", result);
            $$("statusSelect").refresh();
        });
    }

    function getTagsSelect() {
        // делаем запрос в бд
        RefModel.getTags().then(function (result) {
            // заносим в select
            $$("tagsSelect").define("options", result);
            $$("tagsSelect").refresh();
        });
    }

    ///////////////////////////////////////////////// Отрисовка ////////////////////////////////////////////////////

    window.onload = function () {
        webix.ready(function () {

            // Скролл
            if (!webix.env.touch && webix.env.scrollSize)
                webix.CustomScroll.init();

            // Разметка
            webix.ui({
                rows: [
                    toolbar,
                    {
                        cols: [
                            sidebar,
                            {
                                type: "space",
                                cols: [
                                    {
                                        gravity: 0.3,
                                        type: "wide",
                                        rows: [
                                            projects
                                        ]
                                    },
                                    {
                                        rows: [
                                            kanban,
                                            basket
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            });

            setTimeout(getAllTasks, 800);
            // выбираем первый по списку проект
            //let item = $$('listProject').getFirstChildId();
            //console.log(item);
            $$('listProject').select(2);

            getAllProjects();       // Получаем все проекты из бд
            //getAllTasks();          // Получаем все задачи из бд

            getGroupSelect();       // Получаем все группы в select проекта

            getAssignSelect();      // Заполняем
            //getPrioritySelect();    // селекты
            getStatusSelect();      // для
            getTagsSelect();        // задач

            //let subtasks = $$('subTasksTable').data.pull;
            //console.log(subtasks);

            // Подсветка текущей вкладки
            $$("sidebar").select("tasks", true);

            // скрываем корзину
            $$('basket').hide();

            //////////////////////////////////////////// Обработчики ///////////////////////////////////////////////

            // Переход по вкладкам
            $$("sidebar").attachEvent("onItemClick", function (id) {
                location.href = id;
            });

            // Открыть/закрыть sidebar
            $$("toggleIcon").attachEvent("onItemClick", function () {
                $$("sidebar").toggle()
            });

            //********************************************** Проекты ***********************************************//

            // Добавить проект
            $$("addProjectBtn").attachEvent("onItemClick", function () {
                addProjectForm()
            });

            // Окно заполнения проекта
            $$("dltProjectFormBtn").attachEvent("onItemClick", function () {    // кнопка удалить
                delProject();
                $$('project_Form').clearValidation();
            });
            $$("createProjectFormBtn").attachEvent("onItemClick", function () { // кнопка создать
                createProject();
            });
            $$("saveProjectFormBtn").attachEvent("onItemClick", function () {   // кнопка сохранить
                updateProject();
            });
            $$("closeProjectFormBtn").attachEvent("onItemClick", function () {  // кнопка закрыть
                $$('project_window').hide();
                $$('project_Form').clearValidation();
            });

            // Показать попап проекта
            $$("listProject").on_click.listIcon = function (node) {
                $$("edit_Popup").show(node);
            };

            // Действия попапа проекта
            $$("editPopup_List").attachEvent("onItemClick", function (id) {
                let value = this.getItem(id).value;
                switch (value) {
                    case "edit":
                        editProjectForm();
                        break;
                    case "delete":
                        delProject();
                        break;
                }
            });

            // Действия попапа сортировки
            $$("sortPopup_List").attachEvent("onSelectChange", function () {
                let value = this.getSelectedItem().value;
                sortProject(value);
            });

            // Click по проекту (Сделать смену задач)
            $$("listProject").attachEvent("onSelectChange", function () {
                getAllTasks();
            });

            // Редактирование проекта по doubleClick
            $$("listProject").attachEvent("onItemDblClick", function () {
                editProjectForm();
            });

            //********************************************** Задачи ***********************************************//

            // Добавить задачу
            $$("addTaskBtn").attachEvent("onItemClick", function () {
                $$("kanban").showEditor();
                $$('kanban_form').setValues(tasks_originalValues);
            });

            // Создание задачи
            $$('kanban').data.attachEvent("onBeforeAdd", function () {
                createTask();
            });

            // Удаление задачи
            $$('kanban').data.attachEvent("onBeforeDelete", function () {
                let id = $$('kanban').getSelectedId();
                delTask(id);
            });

            // Изменение задачи
            $$('kanban').data.attachEvent("onDataUpdate", function(id, index){
                let task = $$('kanban').getItem(id);
                updateTask(task);
            });

            // Валидация заполнения задачи
            $$("kanban").attachEvent("onBeforeEditorAction", function (action, editor, obj) {
                if (action === "save" && !editor.getForm().validate())
                    return false;
                else if (action === "save") {
                    obj.$list = parseInt(obj.status);
                }
            });

            // Очищение валидации при закрытии окна
            $$("kanban").getEditor().attachEvent("onHide", function () {
                this.getForm().clearValidation();
            });

            //********************************************** Подзадачи ***********************************************//

            // Добавить подзадачу
            $$("subTasksTable").on_click.addSubtaskBtn = function (node) {
                $$('subTasksTable').add({id:$$('subTasksTable').length,check:0, value:''});
            };

            // Удалить подзадачу
            $$("subTasksTable").on_click.delSubtaskBtn = function (node) {
                let id = $$('subTasksTable').getSelectedId();
                $$('subTasksTable').remove(id);
            };

            //********************************************* Drag & Drop **********************************************//

            // получаем node корзины
            let basket_id = $$("basket").getNode();

            webix.attachEvent("onDragMode",function(signal){
                // событие при сбросе элемента над областью корзины
                basket_id.addEventListener('mouseup', handler);
                // показать/скрыть корзину
                switch (signal) {
                    case 'start':
                        $$('basket').show();
                        break;
                    case 'stop':
                        $$('basket').hide();
                        break;
                }
            });

            function handler() {
                // получаем контекст взятия элемента
                let dnd = webix.DragControl.getContext();
                // определяем откуда пришел дроп
                switch (dnd.from.name) {
                    case 'kanbanlist':
                        delTask(dnd.start);
                        $$('kanban').remove(dnd.start);
                        break;
                    case 'Вписать лист проектов':
                        deleteFromGroup(dnd.start);
                        break;
                }
            }
        });
    }
</script>
</body>
</html>