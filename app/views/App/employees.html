<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>pm - employees</title>
    <link rel="stylesheet" href="/public/css/style.css" type="text/css">
    <link rel="stylesheet" href="/public/codebase/webix.css" type="text/css">
    <link rel="stylesheet" href="/public/kanban/codebase/kanban.css" type="text/css">
    <link rel="stylesheet" href="/public/MaterialDesign/css/materialdesignicons.css" type="text/css"
          charset="utf-8">
    <script src="/public/codebase/webix.js" type="text/javascript"></script>
    <script src="/public/kanban/codebase/kanban.js" type="text/javascript"></script>
    <script src="/public/codebase/i18n/ru.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<script type="module">

    webix.i18n.setLocale('ru-RU');

    import {GroupModel} from "/public/js/group/model/GroupModel.js";            // db requests для Групп
    import {EmployeeModel} from "/public/js/employee/model/EmployeeModel.js";   // db requests для Сотрудников

    ///////////////////////////////////////////////// Виджеты //////////////////////////////////////////////////////

    import {toolbar} from "/public/js/toolbar.js";						    // шапка
    import {sidebar} from "/public/js/sidebar.js";						    // боковая панель

    import {groups} from "/public/js/group/groups.js";				        // островок Группы
    import {groupTable} from "/public/js/group/groupTable.js";		        // островок сотрудники Группы
    import {employees} from "/public/js/employee/employees.js";			    // островок Сотрудники

    import {groupWindow} from "/public/js/group/groupWindow.js";		    // окно группы
    webix.ui(groupWindow);

    import {employeeWindow} from "/public/js/employee/employeeWindow.js";	// окно сотрудника
    webix.ui(employeeWindow);

    import {editPopup} from "/public/js/editPopup.js";	    // попап списка [редактировать / удалить]
    webix.ui(editPopup);

    import {sortPopup} from "/public/js/sortPopup.js";					    // попап сортировки [по порядку / по имени / по дате]
    webix.ui(sortPopup);

    import {groups_originalValues} from "/public/js/origValuesForm.js";	    // оригинальные значения формы группы

    ////////////////////////////////////////////////// Функции /////////////////////////////////////////////////////

    function sortGroup(value) {
        $$("listGroup").sort("#" + value + "#");
    }

    function addGroupForm() {
        // Изменяем форму
        $$("titleG").setValue("Добавить группу");
        $$("dltGroupFormBtn").disable();
        $$("saveGroupFormBtn").hide();
        $$("createGroupFormBtn").show();
        // заносим стандартные значения в форму
        $$("groups_Form").setValues(groups_originalValues);
        $$("groups_window").show();
    }

    function editGroupForm() {
        // Изменяем форму
        $$("titleG").setValue("Изменить группу");
        $$("createGroupFormBtn").hide();
        $$("dltGroupFormBtn").enable();
        $$("saveGroupFormBtn").show();
        $$("edit_Popup").hide();
        // заносим данные группы в форму
        let groupValues = $$("listGroup").getSelectedItem();
        $$("groups_Form").setValues(groupValues);
        $$("groups_window").show();
    }

    function getAllGroups() {
        GroupModel.getAll().then(function (result) {
            $$("listGroup").parse(result, 'json');
        });
    }

    function createGroup() {
        // Валидация заполнения
        if ($$("groups_Form").validate()) {
            // берем значения формы
            let group_form = $$("groups_Form").getValues();
            let group = {
                Name: group_form.name,
                Lead: group_form.lead,
            };
            // делаем запрос
            GroupModel.create(group).then(function (result) {
                $$("listGroup").add({
                    id: result[0]['id'],
                    name: result[0]['name'],
                    date: new Date(result[0]['date']),
                    lead: result[0]['lead']
                });
            });
            // закрываем окно
            $$("groups_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проектной группе"});
    }

    function delGroup() {
        // закрываем окна
        $$("edit_Popup").hide();
        $$("groups_window").hide();
        // подтверждение удаления
        webix.confirm({
            ok: "ОК", cancel: "Отмена",
            text: "Вы собираетесь удалить группу, вы уверены?"
        })
            .then(function () {
                // Берем id группы
                let id = $$("listGroup").getSelectedId();
                // делаем запрос
                GroupModel.delete(id).then(function(result) {
                    $$("listGroup").remove(result);
                });
            })
    }

    function updateGroup() {
        // Валидация заполнения
        if ($$("groups_Form").validate()) {
            // берем значения формы
            let id = $$("listGroup").getSelectedId();
            let group_form = $$("groups_Form").getValues();
            let group = {
                Id: id,
                Name: group_form.name,
                Lead: group_form.lead
            };
            // делаем запрос
            GroupModel.update(group).then(function(result) {
                let item = $$("listGroup").getItem(result[0]['id']);
                item.name = result[0]['name'];
                item.lead = result[0]['lead'];
                $$("listGroup").refresh();
            });
            // закрываем окно
            $$("groups_window").hide();
        }
        else
            webix.message({type: "error", text: "Дайте название проектной группе"});
    }

    function editEmployee() {
        let employeeValues = $$("listEmployee").getSelectedItem();
        $$("titleE").setValue("Изменить проект");
        $$("dltEmployeeFormBtn").show();
    }

    function addEmployee() {

    }

    function deleteEmployee() {

    }

    function getAllEmployees() {
        EmployeeModel.getAll().then(function (result) {
            $$("listEmployees").parse(result, 'json');
        });
    }

    function getEmployeeSelect() {
        EmployeeModel.getAll().then(function (result) {
            // создаем переменную для select
            let values = [];
            // заполняем сотрудников
            for (let i = 0; i < result.length; i++) {
                values[i] = result[i].lastName;
            }
            // заносим в select
            $$("employeeSelect").define("options", values);
            $$("employeeCombo").define("options", values);
        });
    }

    function getGroupSelect() {
        GroupModel.getAll().then(function (result) {
            // создаем переменную для select
            let values = [];
            // заполняем группы
            for (let i = 0; i < result.length; i++) {
                values[i] = result[i].name;
            }
            // заносим в select
            $$("groupSelect").define("options", values);
            $$("groupSelect").refresh();
        });
    }

    ///////////////////////////////////////////////// Отрисовка ////////////////////////////////////////////////////

    window.onload = function () {
        webix.ready(function () {

            if (!webix.env.touch && webix.env.scrollSize)
                webix.CustomScroll.init();

            // Разметка
            webix.ui({
                rows: [
                    toolbar,
                    {
                        cols: [
                            sidebar,
                            {
                                type: "space",
                                cols: [
                                    {
                                        gravity: 0.3,
                                        type: "wide",
                                        rows: [
                                            groups
                                        ]
                                    },
                                    {
                                        type: "wide",
                                        cols: [
                                            groupTable,
                                            employees
                                        ]
                                    },
                                ]
                            }
                        ]
                    }
                ]
            });

            getAllGroups(); // Получаем все группы из бд
            getAllEmployees();
            getEmployeeSelect();
            getGroupSelect();

            // подсветка вкладки
            $$("sidebar").select("employees", true);

            //////////////////////////////////////////// Обработчики ///////////////////////////////////////////////

            // Переход по вкладкам
            $$("sidebar").attachEvent("onItemClick", function (id) {
                location.href = id;
            });

            // Открыть/закрыть sidebar
            $$("toggleIcon").attachEvent("onItemClick", function () {
                $$("sidebar").toggle();
            });

            // Добавить группу
            $$("addGroupBtn").attachEvent("onItemClick", function () {
                addGroupForm();
            });

            // Добавить сотрудника
            $$("addEmployeeBtn").attachEvent("onItemClick", function () {
                $$("titleE").setValue("Нанять сотрудника");
                $$("dltEmployeeFormBtn").hide();
                //$$("employees_Form").setValues(employees_originalValues);
                $$("employees_window").show();
            });

            // Открыть поиск сотрудников
            $$("openSearchBtn").attachEvent("onItemClick", function () {
                $$("search").show();
                $$("closeSearchBtn").show();
                $$("openSearchBtn").hide();
            });

            // Закрыть поиск сотрудников
            $$("closeSearchBtn").attachEvent("onItemClick", function () {
                $$("search").hide();
                $$("openSearchBtn").show();
                $$("closeSearchBtn").hide();
            });

            // Показать попап группы
            $$("listGroup").on_click.listIcon = function (node) {
                $$("edit_Popup").show(node);
            };

            // Действия попапа группы
            $$("editPopup_List").attachEvent("onItemClick", function (id) {
                let value = this.getItem(id).value;
                switch (value) {
                    case "edit":
                        editGroupForm();
                        break;
                    case "delete":
                        delGroup();
                        break;
                }
            });

            // Действия попапа сортировки
            $$("sortPopup_List").attachEvent("onSelectChange", function () {
                let value = this.getSelectedItem().value;
                sortGroup(value);
            });

            // Окно заполнения группы
            $$("dltGroupFormBtn").attachEvent("onItemClick", function () {
                delGroup();
                $$('groups_Form').clearValidation();
            });
            $$("saveGroupFormBtn").attachEvent("onItemClick", function () {
                updateGroup()
            });
            $$("createGroupFormBtn").attachEvent("onItemClick", function () {
                createGroup();
            });
            $$("closeGroupFormBtn").attachEvent("onItemClick", function () {
                $$('groups_window').hide();
                $$('groups_Form').clearValidation();
            });

            // Окно заполнения сотрудника
            $$("dltEmployeeFormBtn").attachEvent("onItemClick", function () {
                deleteEmployee();
            });
            $$("saveEmployeeFormBtn").attachEvent("onItemClick", function () {
                addEmployee();
            });
            $$("closeEmployeeFormBtn").attachEvent("onItemClick", function () {
                $$('employees_window').hide();
            });

            // Click по группе (Сделать смену группы)
            $$("listGroup").attachEvent("onItemClick", function () {

            });

            // Редактирование группы по doubleClick
            $$("listGroup").attachEvent("onItemDblClick", function () {
                editGroupForm();
            });

            // Редактирование сотрудника по doubleClick
            $$("listEmployees").attachEvent("onItemDblClick", function () {
                editEmployee();
            });

            // Поиск сотрудников
            $$("search").attachEvent("onTimedKeyPress", function () {
                var value = this.getValue().toLowerCase();

                $$("listEmployees").filter(function (obj) {
                    //return obj.value.toLowerCase().indexOf(value)==0; Начинается с букв
                    return obj.value.toLowerCase().indexOf(value) != -1; // Имеются буквы
                })
            });
        });
    }
</script>
</body>
</html>